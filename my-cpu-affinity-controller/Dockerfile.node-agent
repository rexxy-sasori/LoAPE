# Dockerfile for building the node-agent binary

# Stage 1: Build the Go binary
FROM golang:1.23-alpine AS builder

# Set the working directory inside the container
WORKDIR /workspace

# Copy the Go module files
COPY go.mod go.mod
COPY go.sum go.sum

# Download dependencies
RUN go mod download

# Copy the source code
COPY cmd/node-agent cmd/node-agent
COPY pkg pkg

# Build the node-agent binary
RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -v -ldflags="-w -s" -o bin/node-agent ./cmd/node-agent

# Stage 2: Use Ubuntu 20.04 as the runtime
FROM ubuntu:20.04

# Install necessary dependencies
RUN apt-get update && \
    apt-get install -y \
    util-linux \
    bash \
    ncurses-base 

# Copy the compiled binary from the builder stage
COPY --from=builder /workspace/bin/node-agent /node-agent

# Expose port 8080 for the metrics endpoint
EXPOSE 8080

# Set the entrypoint to the node-agent binary
ENTRYPOINT ["/node-agent"]